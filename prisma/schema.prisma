generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  STAFF
  VIEWER
}

model Company {
  id         String      @id @default(cuid())
  name       String      @unique
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  warehouses Warehouse[]
}

model Warehouse {
  id            String             @id @default(cuid())
  name          String
  code          String             @unique
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  companyId     String
  balances      InventoryBalance[]
  movementsFrom StockMovement[]    @relation("FromWarehouse")
  movementsTo   StockMovement[]    @relation("ToWarehouse")
  company       Company            @relation(fields: [companyId], references: [id])
  users         UserWarehouse[]
}

model Product {
  id          String             @id @default(cuid())
  sku         String             @unique
  name        String
  barcode     String?            @unique
  description String?
  unit        String             @default("ea")
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  
  // Demo/Testing fields - auto-cleanup after 1 hour
  isDemo      Boolean            @default(false)
  expiresAt   DateTime?
  
  balances    InventoryBalance[]
  movements   StockMovement[]
}



model InventoryBalance {
  id          String    @id @default(cuid())
  quantity    Int       @default(0)
  updatedAt   DateTime  @updatedAt
  productId   String
  warehouseId String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
}



model StockMovement {
  id              String       @id @default(cuid())
  type            MovementType
  quantity        Int
  note            String?
  createdAt       DateTime     @default(now())
  
  createdByUserId String?
  createdByUser   User?        @relation(fields: [createdByUserId], references: [id])

  productId       String
  product         Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  fromWarehouseId String?  
  fromWarehouse   Warehouse?   @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  
  toWarehouseId   String?
  toWarehouse     Warehouse?   @relation("ToWarehouse", fields: [toWarehouseId], references: [id])
}



model User {
  id           String   @id @default(cuid())
  name         String?
  email        String?   @unique
  emailVerified DateTime?
  image        String?
  
  role         Role     @default(VIEWER)
  passwordHash String? //credenciales login
  isActive     Boolean  @default(true)
  
  // Demo/Testing fields - auto-cleanup after 1 hour
  isDemo       Boolean  @default(false)
  expiresAt    DateTime?
  
  accounts     Account[]
  sessions     Session[]
  stockMovements StockMovement[]
  warehouses   UserWarehouse[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}


model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}


model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}


model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model UserWarehouse {
  id          String    @id @default(cuid())
  userId      String
  warehouseId String
  assignedAt  DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, warehouseId])
}

model SystemSettings {
  id            String   @id @default(cuid())
  systemName    String   @default("Inventory System")
  theme         String   @default("light")
  
  // Security settings
  maxLoginAttempts    Int      @default(5)
  lockoutDurationMins Int      @default(15)
  sessionTimeoutMins  Int      @default(480)
  demoDataRetentionHours Int   @default(1)
  
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
}

enum MovementType {
  IN
  OUT
  ADJUST
  TRANSFER
}
